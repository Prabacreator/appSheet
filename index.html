<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- style css -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/sweetalert.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #ccc;
      text-transform: capitalize;
      font-family: 'Ubuntu', sans-serif;
    }
    .container{
      display: flex;
      width: 100%;
      min-height: 100vh;
      justify-content: center;
      align-items: center;
    }
    @media (min-width: 768px) {
      .container {	
      	max-width: 420px;
      }
    }
    .card{
      width: 100%;
      height: 100%;
      display: block;
      align-items: center;
      justify-content: center;
    }
    .card-body{
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .form-control,
    .fw-bold,
    .btn{
      text-transform: capitalize;
    }
    .text-transparent {
      color: transparent!important;
    }
    table{
      width: 100%;
      font-size: 0.75rem;
      table-layout: auto;
      border-collapse: collapse; 
      text-transform: capitalize;
    }
    table th, 
    table td{
      width: fit-content;
      text-align: center;
      white-space: nowrap;
      word-wrap: break-word;
      vertical-align: middle;
      border: 0.25px solid#ccc;
    }
    tbody tr:hover{
      color: #f00;
      background-color: #ccc;
    }
    tfoot th,
    tfoot td{
      border: none;
    }
  </style>
</head>
<body class="text-center">
  
  <div class="container">
    <div class="card">
      <!--header-->
      <div class="card-header">
        <div class="d-flex justify-content-between">
          <div class="fs-1 fw-bold">job activity</div>
          <div id="timestamp" style="font-size: 0.75rem"></div>
        </div>
      </div>
      <!--body-->
      <div class="card-body">
        <div class="table-responsive"></div>
      </div>
      <!--footer-->
      <div class="card-footer">
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-sm btn-outline-dark" onclick="loadForm('new')">NEW</button>
          <select id="select" class="form-select form-select-sm w-50 mx-2"></select>
          <button id="add" type="button" class="btn btn-sm btn-outline-dark d-none" >ADD</button>
        </div>
        <div class="my-2">
          <button id="pdf" type="button" class="btn btn-sm btn-outline-dark d-none" onclick="printPDF()">PDF</button>
        </div>
      </div>
    </div>
  </div>
  <!-- javaScript -->
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/sweetalert.min.js"></script>
  <script src="js/html2canvas.min.js"></script>
  <script src="js/jspdf.umd.min.js"></script>
  <script>
    var scriptUrl = 'https://script.google.com/macros/s/AKfycbyBd7Ix3evs_u9oVE9_2DuVpSPSN2315vZLxmBA2SP-3vE5UQEkd9eAaCcw39dwwjwhuA/exec';
    
    window.addEventListener('load',loadSheet,true)
    
    function loading(){
      Swal.fire({
        title: 'Loading...',
        text: 'Please wait',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });
    } 
    
    function message(data){
      Swal.close();
      Swal.fire({ text: data, allowOutsideClick: true, showConfirmButton: false })
    }
    
    function loadSheet(){
      loading();
      document.getElementById('timestamp').textContent = new Date().toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      var select = document.getElementById('select');
      fetch(scriptUrl)
      .then(response => response.json())
      .then(data => {
        select.innerHTML='<option>Buka data</option>';
        data.splice(1).forEach(sh=> {
          var option = document.createElement('option');
          option.textContent = sh;
          select.appendChild(option);
        });
        select.addEventListener('change',function(){optiSheet(this.value);});
        Swal.close();
      })
      .catch(error => message(error));  
    }
    
    function optiSheet(name){
      Swal.fire({
        icon: 'question',
        title: 'Pilih Aksi',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'Buka',
        denyButtonText: 'Hapus',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          loading();
          loadData(name);
        } else if (result.isDenied) {
          Swal.fire({
            title: 'Hapus Data',
            text: 'Apakah Anda yakin ingin menghapus data ini?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Hapus',
            confirmButtonColor: '#dc3545',
            cancelButtonText: 'Batal'
          }).then((result) => {
            if (result.value) {
              loading();
              fetch(scriptUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `action=del_sheet&name=${name}`
              })
              .then(response => response.text())
              .then(data => {
                message(data);
                loadData(name);
              })
              .catch(error => {
                message(error);
                Swal.close();
              });
            }
          });
        }
      });
    }
    
    
    function loadData(key) {
      let html = '';
      fetch(`${scriptUrl}?keyword=${encodeURIComponent(key)}`).then(res => res.json()).then(data => {
    
        let works  = data.filter(a => a.work).length;
        let overs  = data.filter(a => a.over).length;
        let wages  = data.reduce((sum, a) => sum + (parseInt(a.wages) || 0), 0);
        let debet  = data.reduce((sum, a) => sum + (parseInt(a.debt)  || 0), 0);
        let credit = data.reduce((sum, a) => sum + (parseInt(a.pays)  || 0), 0);
        let saldo = wages - (debet + credit);
        
        html += `<div id="title" class="fs-2 fw-bold text-primary">${key}</div><div class="fw-bold text-start">absensi kerja</div><table class="my-2"><thead><tr> <th rowspan="2">No</th><th rowspan="2">Tanggal</th><th colspan="2">Status</th> <th rowspan="2">Upah</th></tr><tr style="font-size:0.35rem"><th>kerja</th><th>over<br>time</th></tr></thead>`;
        
        data.filter(a => a.work >0 || a.over >0).forEach((a, i) => {
          html += `<tbody><tr><td>${i + 1}</td><td onclick="actions('add','${key}',['${a.date}','${a.work}','${a.over}','${a.wages}','${a.debt}','${a.pays}','${a.desc}'])">${a.date}</td><td><input type="checkbox" ${a.work ? 'checked' : ''}  disabled/></td><td><input type="checkbox" ${a.over ? 'checked' : ''} ${a.over >0 ? `onclick="message('${a.desc}')"` : ''} disabled/></td><td class="${a.wages > 0 ? 'text-end pe-1' : 'text-transparent'}" ${a.over >0 ? `onclick="message('${a.desc}')"` : ''}>${a.wages}</td></tr></tbody>`;
        });
        html += `<tfoot><tr class="text-danger"><th colspan="2" class="text-end pe-1">=></th><th>${works}</th><th>${overs}</th><th class="text-end pe-1">${wages}</th></tr></tfoot></table>`;
        
        html += `<div class="fw-bold text-start">transaksi upah</div><table class="my-2"><thead><tr><th>No</th><th>Tanggal</th><th>Kasbon</th><th>Dibayar</th></tr></thead>`;
        
        data.filter(a => a.debt > 0 || a.pays > 0).forEach((a, i) => {
          html += `<tbody><tr ${a.debt > 0 || a.pays >0 ? `onclick="message('${a.desc}')"` : ''}><td>${i + 1}</td><td>${a.date}</td><td class="${a.debt > 0 ? 'text-end pe-1' : 'text-transparent'}">${a.debt}</td><td class="${a.pays > 0 ? 'text-end pe-1' : 'text-transparent'}">${a.pays}</td></tr></tbody>`;
        });
        html += `
        <tfoot><tr class="text-danger"><th colspan="2" class="text-end pe-1">=></th><th class="text-end pe-1">${debet}</th><th class="text-end pe-1">${credit}</th></tr>
        <tr><th colspan="2" class="text-start ps-2 pt-3">bekerja</th><td class="text-end pe-2 pt-3">${works} hari</td></tr>
        <tr><th colspan="2" class="text-start ps-2">overtime</th><td class="text-end pe-2">${overs} kali</td></tr>
        <tr><th colspan="2" class="text-start ps-2">Total Upah</th><td class="text-end pe-2">${wages}</td></tr>
        <tr><th colspan="2" class="text-start ps-2">Total kasbon</th><td class="text-end pe-2">${debet}</td></tr>
        <tr><th colspan="2" class="text-start ps-2">Total dibayar</th><td class="text-end pe-2">${credit}</td></tr>
        <tr style="font-size: 1rem;"><th colspan="3" class="${saldo !== 0 ? 'text-danger' : 'text-center font-monospace text-info py-2'}">${saldo > 0 ? `Upah Sisa : ${saldo}` : saldo < 0 ? `Upah Minus : ${Math.abs(saldo)}`: 'Lunas !.'}</th></tr>
        </tfoot></table>`;
        
        const table = document.querySelector('.table-responsive');
        table.innerHTML = html;
        const add = document.querySelector('#add');
        const pdf = document.querySelector('#pdf');
        [add,pdf].forEach(el=>{el.classList.remove('d-none')});
        add.onclick=()=> loadForm('add',key);
        Swal.close();
      }).catch(err => loadInfo(err));
    }
    
    function loadForm(type, name, index=''){
      let action = index ? 'set' : 'add';
      if(type === 'new'){
        Swal.fire({
          title: 'New Data',
          html: `
          <input type="text" id="name" name="name" class="form-control text-center" required>`,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: 'Simpan',
          confirmButtonColor: '#198754',
          cancelButtonText: 'Batal',
          preConfirm: () => {
            return { name: document.getElementById('name').value
            }
          }
          }).then((result) => {
          if (result.value) {
            loading();
            fetch(scriptUrl, {
              method: 'POST',
              headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              body: `action=sheet&name=${result.value.name}`
            })
            .then(response => response.text())
            .then(data => {
              message(data);
              loadSheet();
            })
            .catch(error => message(error));
          }
        });
      }else if(type === 'add'){
        Swal.fire({
          title: name,
          html: ` 
          <div class="text-start">
          <div class="d-flex justify-content-between align-items-start my-1">
            <label class="fw-bold">Tanggal</label>
            <input type="text" id="date" class="form-control form-control-sm text-center w-50" value="${index ? index[0] : new Date().toLocaleString('id-ID')}" required>
          </div>
          <label class="fw-bold">Status Kerja</label>
          <div class="d-flex justify-content-between align-items-start my-1">
            <label class="ps-2">Bekerja</label>
            <input type="text" id="work" class="form-control form-control-sm text-center w-50" list="true/false" value="${index ? index[1] : 'false'}" onclick="document.getElementById('work').value=null">
          </div>
          <div class="d-flex justify-content-between align-items-start my-1">
            <label class="ps-2">Overtime</label>
            <input type="text" id="over" class="form-control form-control-sm text-center w-50" list="true/false" value="${index ? index[2] : 'false'}" onclick="document.getElementById('over').value=null">
          </div>
          <div class="d-flex justify-content-between align-items-start my-1">
            <label class="fw-bold">Upah Harian</label>
            <input type="number" id="wages" class="form-control form-control-sm text-center w-50" list="listwages" value="${index ? index[3] : ''}">
          </div>
          <label class="fw-bold">Transaksi Upah</label>
          <div class="d-flex justify-content-between align-items-start my-1">
            <label class="ps-2">Kasbon</label>
            <input type="number" id="debt" class="form-control form-control-sm text-center w-50" value="${index ? index[4] : ''}">
          </div>
          <div class="d-flex justify-content-between align-items-start my-1">
            <label class="ps-2">Dibayar</label>
            <input type="number" id="pays" class="form-control form-control-sm text-center w-50" value="${index ? index[5] : ''}">
          </div>
          <label class="fw-bold">Deskripsi</label>
          <textarea name="desc" id="desc" class="form-control form-control-sm" onclick="empty('desc')">${index ? index[6] : ''}</textarea>
          <datalist id="true/false">
            <option>true</option>
            <option>false</option>
          </datalist>
          <datalist id="listwages"></datalist></div>`,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: 'Simpan',
          confirmButtonColor: '#198754',
          cancelButtonText: 'Batal',
          didOpen: () => {
            var list = document.getElementById('listwages');
            fetch(`${scriptUrl}?keyword=${encodeURIComponent(name)}`)
              .then(response => response.json())
              .then(data => {
                var listwages = [];
                data.forEach((a)=>{
                  if (a.wages !== 0 && !listwages.includes(a.wages)) {
                    listwages.push(a.wages);
                    var opt = document.createElement('option');
                    opt.textContent = a.wages;
                    list.appendChild(opt);
                  }
                })
              }).catch(error => console.error(error));
          },
          preConfirm: () => {
            return {
              name: name,
              date: document.getElementById('date').value,
              work: document.getElementById('work').value,
              over: document.getElementById('over').value,
              wages: document.getElementById('wages').value || 0,
              debt: document.getElementById('debt').value || 0,
              pays: document.getElementById('pays').value || 0,
              desc: document.getElementById('desc').value
            }
          }
        }).then((result) => {
          if (result.value) {
            loading();
            fetch(scriptUrl, {
              method: 'POST',
              headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              body: `action=${action}&name=${result.value.name}&date=${result.value.date}&work=${result.value.work}&over=${result.value.over}&wages=${result.value.wages}&debt=${result.value.debt}&pays=${result.value.pays}&desc=${result.value.desc}`
            })
            .then(response => response.text())
            .then(data => {
              message(data);
              Swal.close();
              loadData(name);
            })
            .catch(error => {
              message(error);
              Swal.close();
            });
          }
        });
      }
    }
    
    function actions(type, name, index){
      Swal.fire({
        icon: 'question',
        title: 'Pilih Aksi',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'Edit',
        denyButtonText: 'Hapus',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          loadForm(type, name, index)
        } else if (result.isDenied) {
          Swal.fire({
            title: 'Hapus Data',
            text: 'Apakah Anda yakin ingin menghapus data ini?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Hapus',
            confirmButtonColor: '#dc3545',
            cancelButtonText: 'Batal'
          }).then((result) => {
            if (result.value) {
              loading();
              fetch(scriptUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `action=del&name=${name}&date=${index[0]}`
              })
              .then(response => response.text())
              .then(data => {
                message(data);
                loadData(name);
              })
              .catch(error => {
                message(error);
                Swal.close();
              });
            }
          });
        }
      });
    }
    
    function printPDF() {
      const title = document.getElementById('select').value;
      const target = document.querySelector('.card-body'); // FIX selector
    
      if (!target || !target.innerHTML.trim()) {
        Swal.fire({
          icon: 'warning',
          text: 'Data belum ditampilkan'
        });
        return;
      }
    
      Swal.fire({
        title: 'Membuat PDF...',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => Swal.showLoading()
      });
    
      html2canvas(target, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff'
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    
        const pageWidth  = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
    
        const imgWidth = pageWidth - 20;
        const imgHeight = canvas.height * imgWidth / canvas.width;
    
        let y = 10;
        let heightLeft = imgHeight;
    
        pdf.addImage(imgData, 'PNG', 10, y, imgWidth, imgHeight);
        heightLeft -= pageHeight;
    
        while (heightLeft > 0) {
          y = heightLeft - imgHeight + 10;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 10, y, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
    
        Swal.close();
        pdf.save(`${title}.pdf`);
      }).catch(err => {
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: err.message || err
        });
      });
    }
  </script>
</body>
</html>