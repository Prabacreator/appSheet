<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>greens4pk</title>
  <!-- STYLE CSD -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/sweetalert.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<style>
:root {
  --bs-primary:#0d6efd;
  --bs-secondary:#6c757d;
  --bs-success:#198754;
  --bs-info:#0dcaf0;
  --bs-warning:#ffc107;
  --bs-danger:#dc3545;
  --bs-light:#f8f9fa;
  --bs-dark:#212529;-
}
body{ font-family: system-ui, -apple-system, "Segoe UI", sans-serif;background:#f8f9fa;}
.container{max-width: 41em; overflow-x: auto;-webkit-overflow-scrolling: touch;}
@media(min-width:768px){.container{max-width:420px}}
.Offcanvas{background-color: transparent!important;}
.small{font-size: 0.75rem!important;}
.tiny{font-size: 0.35rem!important;}
a{text-decoration: none!important}


.btn{border-radius: 17px!important;}
.border{border: 0.3px solid#000!important;border-radius: 25px!important;}
.border-bottom{border-bottom:0.3px solid#ccc!important;}
.transparent{color: transparent!important;}

/* input css */
label,.btn,.fw-bold,.form-control{text-transform: capitalize!important;}
.form-select,.form-select:focus{box-shadow: none;border: none!important;--bs-border-color: transparent;--bs-focus-ring-color: transparent;background-color: transparent!important;}
.form-control{border:.3px solid#000!important;background-color: transparent!important;font-size:1.2rem!important;color:var(--bs-primary)!important;text-shadow: 1px 1px#212529;}
input[type=text],input[type=number]{border-radius: 50px!important;}
input[type=number]{font-weight: bold;text-align: center;}

/* table css */
.table-responsive{justify-content: center!important;text-align: center!important;align-items: center!important;}
table{width:100%;table-layout: auto; text-transform: capitalize;border-collapse: collapse;}
table th,table td{font-size;0.75rem;width: fit-content;white-space: nowrap;word-wrap: break-word;vertical-align: middle;font-family: var(--bs-font-monospace)!important;border:.2px solid#ccc;}
tfoot th, tfoot td{border:none!important;}

/* sweetalert2 css */
.swal2-popup{padding: 1.5rem border-radius: 1rem; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;}
.swal2-title{font-size: 1.25rem; font-weight: 700;}
.swal2-html-container{ font-size: .95rem; color: #555;}
.swal2-confirm{ color: var(--bs-dark); background: var(--bs-info); border-radius: 25px;  padding: .5rem 1.25rem;  font-weight: 600;}
.swal2-cancel{ color: var(--bs-dark); background: var(--bs-info-bg-subtle); border-radius: 25px; padding: .5rem 1.25rem; font-weight: 600;}
.swal2-icon{margin-top: .5rem;}
</style>
</head>
<body class="bg-light-subtle">
  <!-- FLOATBTN -->
  <div id="floatBtn" class="bg-info"></div>
  <div class="container py-2">
    <!-- TABLE -->
    <div class="d-flex justify-content-between px-2 text-shadow border-bottom">
      <div class="fs-1 mt-3 fw-bold text-info" style="text-shadow: 1px 4px 4px #000">Job Actifity</div>
      <div class="mb-3">
        <div id="datestamp" class="mb-3"></div>
      </div>
    </div>
    <div class="my-1">
      <!-- SELECT SHEET -->
      <select id="sheetSelect" class="form-select form-select-sm fs-5 fw-bold w-auto"></select>
      <!-- FILTER WEEK -->
      <select id="selectWeek" class="form-select form-select-sm w-auto"></select>
    </div>
    <a href="#">
    <div class="table-responsive">
      <table id="table" ></table>
    </div>
    </a>
  </div>

<!-- OFFCANVAS INPUT DATA -->
<div class="offcanvas offcanvas-start w-100 h-100" tabindex="-1" id="formData">
  <div class="offcanvas-body d-flex justify-content-center flex-column">
    <div class="card mb-2">
      <div class="card-header text-bg-info">
        <div class="d-flex justify-content-between mb-2">
          <h5 class="fw-bold">Input Data</h5>
          <button class="btn btn-sm bg-info-subtle" onclick="sharePDF()">Share <i class="bi bi-share ms-2"></i></button>
        </div>
        
        <div class="d-flex justify-content-between border p-1">
          <button id="delSheet" type="button" class="btn btn-sm bg-info-subtle" onclick="delSheet()">Hapus semua data</button>
          <div id="user" class="fw-bold fs-4 me-2" onclick="unlockSheet()"></div>
        </div>
      </div>
      <div class="card-body bg-info-subtle">
        <div class="form-group mb-1">
          <input type="hidden" id="row">
          <label class="form-label">Tanggal</label>
          <input type="text" id="date" class="form-control form-control-sm text-center">
        </div>
        <div class="form-group d-flex justify-content-between mb-1">
          <label class="form-label">Periode</label>
          <input type="number" id="week" class="form-control form-control-sm w-50" list="weekList">
          <datalist id="weekList"></datalist>
        </div>
        <div class="form-group mb-1">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="work">
            <label class="form-check-label">Bekerja</label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="over">
            <label class="form-check-label">Overtime</label>
          </div>
        </div>
        <div class="form-group d-flex justify-content-between mb-1">
          <label class="form-label">Upah</label>
          <input type="number" id="wages" class="form-control form-control-sm w-50" list="wagesList">
          <datalist id="wagesList"></datalist>
        </div>
        <div class="form-group d-flex justify-content-between mb-1">
          <label class="form-label">Kasbon</label>
          <input type="number" id="debt" class="form-control form-control-sm w-50">
        </div>
        <div class="form-group d-flex justify-content-between mb-1">
          <label class="form-label">Dibayar</label>
          <input type="number" id="pays" class="form-control form-control-sm w-50">
        </div>
        <div class="form-group">
          <label class="form-label">Deskripsi</label>
          <textarea id="desc" class="form-control" style="height:100px"></textarea>
        </div>
      </div>
      <div class="card-footer  bg-dark-subtle py-3">
        <div class="d-flex justify-content-between mb-3">
          <button id="del" type="button" class="btn btn-sm btn-danger px-2 d-none" onclick="delRow()"><i class="bi bi-trash me-2"></i>Hapus</button>
          <button class="btn btn-sm btn-dark px-2" onclick="resetForm()"><i class="bi bi-gear me-2"></i>Reset</button>
          <button id="add" class="btn btn-sm btn-success px-2 w-50" onclick="saveRow()"><i class="bi bi-floppy me-2"></i>Simpan</button>
        </div>
        <button class="btn btn-sm btn-primary px-2" onclick="toggleFormSheet()"><i class="bi bi-pencil-square me-1"></i> Buat  Data Baru</button>
      </div>
    </div>
  </div>
</div>

<!-- OFFCANVAS INPUT SHEET-->
<div class="offcanvas offcanvas-start w-100 h-100" tabindex="-1" id="formSheet">
  <div class="offcanvas-body d-flex justify-content-center flex-column">
    <div class="card">
      <div class="card-header text-bg-info">
        <h5 class="fw-bold">Data Baru</h5>
      </div>
      <div class="card-body bg-info-subtle">
        <div class="form-group mb-2">
          <label class="form-label">Nama lengkap</label>
          <input type="text" id="username" class="form-control text-center" oninput="this.value = this.value.replace(/\b\w/g, c => c.toUpperCase())">
        </div>
      </div>
      <div class="card-footer text-center bg-dark-subtle">
        <button class="btn btn-sm btn-primary px-2 mb-3" onclick="addSheet()"><i class="bi bi-floppy me-2"></i>Simpan  Data Baru</button>
      </div>
    </div>
  </div>
</div>

<!-- JAVA SCRIPT -->
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/sweetalert.min.js"></script>
<script src="js/html2canvas.min.js"></script>
<script src="js/jspdf.umd.min.js"></script>
<!-- fungsi floatBtn -->
<script>
const btn = document.getElementById('floatBtn');
btn.style = 'position: fixed; width: 56px; height: 56px; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: grab; z-index: 9999; transition: left .25s ease, top .25s ease, transform .15s;box-shadow: 0rem 2rem 3rem#000!important;#floatBtn:active{cursor: grabbing; transform: scale(.92);';
const KEY = 'floatBtnPos';
let drag=false, ox=0, oy=0;
const loadPos=()=>{
  const p=JSON.parse(localStorage.getItem(KEY));
  if(p){ btn.style.left=p.x+'px'; btn.style.top=p.y+'px'; }
  else{ btn.style.right='20px'; btn.style.bottom='20px'; }
};
const savePos=()=>{
  const r=btn.getBoundingClientRect();
  localStorage.setItem(KEY,JSON.stringify({x:r.left,y:r.top}));
};
const start=e=>{
  drag=true; btn.style.transition='none';
  const r=btn.getBoundingClientRect();
  const x=e.touches?e.touches[0].clientX:e.clientX;
  const y=e.touches?e.touches[0].clientY:e.clientY;
  ox=x-r.left; oy=y-r.top;
};
const move=e=>{
  if(!drag) return;
  e.preventDefault();
  const x=e.touches?e.touches[0].clientX:e.clientX;
  const y=e.touches?e.touches[0].clientY:e.clientY;
  btn.style.left=(x-ox)+'px';
  btn.style.top =(y-oy)+'px';
  btn.style.right='auto';
  btn.style.bottom='auto';
};
const end=()=>{
  if(!drag) return; drag=false;
  const r=btn.getBoundingClientRect();
  const vw=innerWidth, vh=innerHeight;
  const x=r.left<vw/2 ? 10 : vw-r.width-10;
  let y=Math.max(10,Math.min(vh-r.height-10,r.top));
  btn.style.transition='left .25s, top .25s';
  btn.style.left=x+'px'; btn.style.top=y+'px';
  savePos();
};
btn.addEventListener('mousedown',start);
document.addEventListener('mousemove',move);
document.addEventListener('mouseup',end);
btn.addEventListener('touchstart',start,{passive:false});
document.addEventListener('touchmove',move,{passive:false});
document.addEventListener('touchend',end);
btn.addEventListener('click', () => {
  if(drag) return;
  //* isi fungsi klick ..
  toggleOffCanvas();
});
document.addEventListener('DOMContentLoaded',loadPos);
</script>
<script>
/* == KONSTANTA & HELPER == */
const url = 'https://script.google.com/macros/s/AKfycbwso55JoQEqBTgKoIIB8NdDQNuk-KdcedP1Qb5tooUVIbSC_9ZzD2-3QY2uEq8ORZ0W/exec';
const $ = id => document.getElementById(id);
const num = v => Number(v) || 0;
const isTrue = v => v === true || v === 'TRUE' || v === 'true' || v === 1 || v === '1';

const times = new Date().toLocaleDateString('id-ID', {weekday: 'long',day: '2-digit',month: 'short',year: 'numeric'});

/* == STATE == */
const state = {
  sheet : '',
  week  : '',
  data  : [],
  view  : [],
  locked: false
};

/* == UTIL == */
function weekFromDate(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  return isNaN(d) ? '' : Math.ceil(d.getDate() / 7);
}


/* == SWEETALERT LOADING == */
const showLoading = () => {
  Swal.fire({
    title:'Loading...',
    allowOutsideClick:false,
    showConfirmButton:false,
    didOpen: () => Swal.showLoading()
  });
};
const hideLoading = () => Swal.close();

/* == LOAD SHEET LIST == */
function unlockSheet(){
  state.locked = !state.locked;
  if(state.locked){
    user.textContent =`ðŸ”’ ${state.sheet}`;
    Swal.fire({icon:'success', text:'Data ini berhasil dikunci'});
  }else{
    user.textContent = state.sheet;
    Swal.fire({icon:'success', text:'Data ini tidak terkunci'});
  }
}

async function loadSheets(){
  showLoading();
  try{
    const r = await fetch(url+'?'+new URLSearchParams({action:'getSheets'})).then(r=>r.json());
    
    if(!r.data.length){
      hideLoading();
      const c = await Swal.fire({icon:'warning',text:'Data kosong, Silakan input data'});
      if(!c.isConfirmed) return;
      bootstrap.Offcanvas.getOrCreateInstance(formSheet).show();
      
    }
    
    sheetSelect.innerHTML =
      `<option disabled selected>Pilih Data</option>` +
      (r.data||[]).map(v=>`<option>${v}</option>`).join('');

    sheetSelect.onchange = async () => {
      if(state.sheet && state.locked){
        const c = await Swal.fire({icon:'question',text:'Anda akan beralih data ?',showCancelButton:true,});
        if(!c.isConfirmed){
          sheetSelect.value = state.sheet;
          return;
        }
      }

      state.sheet  = sheetSelect.value;
      state.week   = '';
      state.locked = true;
      user.textContent = `ðŸ”’ ${state.sheet}`;
      loadData();
    };

    datestamp.textContent = times;
    date.value = times;

  }catch(err){
    Swal.fire({icon:'error',text:err.message||err});
  }finally{
    hideLoading();
  }
}

/* == SHEET CRUD == */
async function addSheet(){
  if(!username.value) return Swal.fire({icon:'warning', text: 'ðŸ‘‹ Ops !.. Silakan masukan data',});
  const name=username.value.trim();
  bootstrap.Offcanvas.getOrCreateInstance(formSheet).hide();
  await fetch(url,{method:'POST',body:new URLSearchParams({action:'add_sheet',name})});
  state.sheet=name;
  state.locked=true;
  user.textContent=`ðŸ”’ ${name}`;
  bootstrap.Offcanvas.getOrCreateInstance(formData).show();
  loadSheets();
}

async function delSheet(){
  if(state.locked) return Swal.fire({icon:'warning',text: 'ðŸ‘‹ Ops !.. Data terkunci, Silakan buka dulu.'});
  if(!state.sheet) return;

  const c=await Swal.fire({icon:'warning',title:'Hapus',text:`Yakin mau hapus semua data ${state.sheet} ?`,showCancelButton:true,confirmButtonText:'Ya, Hapus'});
  if(!c.isConfirmed) return;
  bootstrap.Offcanvas.getOrCreateInstance(formData).hide();
  await fetch(url,{method:'POST',body:new URLSearchParams({action:'del_sheet',name:state.sheet})});
  state.sheet='';
  state.locked=false;
  table.innerHTML='';
  loadSheets();
}

/* == LOAD DATA == */
async function loadData(){
  if(!state.sheet) return;
  showLoading();

  const r = await fetch(
    url+'?'+new URLSearchParams({action:'getData',sheet:state.sheet})
  ).then(r=>r.json());

  state.data = Array.isArray(r.data) ? r.data : [];
  state.view = [...state.data];

  const weeks = [...new Set(
    state.data.map(d=>Number(d.week)).filter(v=>!isNaN(v))
  )].sort((a,b)=>b-a);

  selectWeek.innerHTML =
    `<option value="">Semua Periode</option>` +
    weeks.map(w=>`<option value="${w}">Periode ${w}</option>`).join('');

  weekList.innerHTML = weeks.map(w=>`<option value="${w}">${w}</option>`).join('');

  selectWeek.onchange = e=>{
    const val = Number(e.target.value);
    state.week = val||'';
    state.view = val
      ? state.data.filter(d=>Number(d.week)===val)
      : [...state.data];

    datestamp.textContent = val
      ? state.view.map(d=>d.date).filter(Boolean).sort((a,b)=>new Date(a)-new Date(b)).pop() || times
      : times;

    renderTable();
  };
  
  const wages = [...new Set(
    state.data.map(d=>Number(d.wages)).filter(v=>!isNaN(v))
  )].sort((a,b)=>b-a);
  
  wagesList.innerHTML = wages.map(w=>`<option value="${w}">${w}</option>`).join('');
  
  renderTable();
}

/* == RENDER TABLE == */
async function renderTable(){
  table.innerHTML = '';
  if(!state.view.length){
    hideLoading();
    const c = await Swal.fire({icon:'warning',text:'Data kosong, Silakan input data'});
    if(!c.isConfirmed) return;
    bootstrap.Offcanvas.getOrCreateInstance(formData).show();
  }

  const sum = k => state.view.reduce((s,a)=>s+(+a[k]||0),0);
  const saldo = sum('wages') - (sum('debt') + sum('pays'));

  table.innerHTML = `
  <thead><tr class="text-center">
    <th rowspan="2">No</th>
    <th rowspan="2">Tanggal</th>
    <th colspan="2">Status</th>
    <th rowspan="2">Upah</th>
    <th colspan="2">Transaksi</th>
  </tr><tr class="text-center">
    <th class="tiny">Kerja</th>
    <th class="tiny">Over<br>time</th>
    <th class="small">Kasbon</th>
    <th class="small">Dibayar</th>
  </tr></thead><tbody>`;
  table.innerHTML += state.view.map((a,i)=>{
    const desc = a.desc && a.desc.trim();
    return `
    <tr class="text-end pe-2" onclick="editRow(${i})">
      <th rowspan="${desc ? 2:1}">${i+1}</th>
      <td class="small text-start ps-2">${String(a.date)||'-'}</td>
      <td class="text-center">${a.work?'âœ”':''}</td>
      <td class="text-center">${a.over?'âœ”':''}</td>
      <td>${a.wages||''}</td>
      <td>${a.debt||''}</td>
      <td>${a.pays||''}</td>
    </tr>${a.desc?`<tr>
      <th colspan="6"  class="tiny text-start ps-2"><i>${a.desc}</i></th>
    </tr>` : '' }`}).join('');
    
  table.innerHTML += `
  </tbody><tfoot><tr class="text-end pe-2">
    <th colspan="3">${state.view.filter(a=>a.work).length}</th>
    <th>${state.view.filter(a=>a.over).length}</th>
    <th>${sum('wages')}</th>
    <th>${sum('debt')}</th>
    <th>${sum('pays')}</th>
  </tr><tr class="text-end pe-2">
    <th colspan="5">${saldo>0?'SISA':saldo<0?'MINUS':'LUNAS'}</th>
    <th colspan="2">${saldo!==0?Math.abs(saldo):'âœ”'}</Math>
  </tr></tfoot>`;
  hideLoading();
}

/* == CRUD ROW == */
function toggleOffCanvas(){
  resetForm();
  if(!state.sheet){
    bootstrap.Offcanvas.getOrCreateInstance(formSheet).toggle();
    bootstrap.Offcanvas.getOrCreateInstance(formData).hide();
  }else{
  bootstrap.Offcanvas.getOrCreateInstance(formData).toggle();
  };
}

function toggleFormSheet(){
  state.sheet = '';
  table.innerHTML ='';
  loadSheets();
  bootstrap.Offcanvas.getOrCreateInstance(formSheet).show();
  bootstrap.Offcanvas.getOrCreateInstance(formData).hide();
  resetForm();
}

async function editRow(i){
  const d = state.view[i];
  const real = state.data.indexOf(d);
  
  Object.keys(d).forEach(k=>{
    const el=$(k);
    if(!el) return;
    el.type==='checkbox' ? el.checked=isTrue(d[k]) : el.value=d[k];
  });
  
  row.value = real+2;
  add.innerHTML='Update';
  del.classList.remove('d-none');
  bootstrap.Offcanvas.getOrCreateInstance(formData).show();
}

async function saveRow(){
  bootstrap.Offcanvas.getOrCreateInstance(formData).hide();
  const autoWeek = week.value || weekFromDate(date.value);
  
  const r = await fetch(url,{
    method:'POST',
    body:new URLSearchParams({
      action: row.value?'set_row':'add_row',
      name  : state.sheet,
      row   : row.value,
      date  : `'`+date.value || `'`+times,
      week  : autoWeek,
      work  : work.checked,
      over  : over.checked,
      wages : num(wages.value),
      debt  : num(debt.value),
      pays  : num(pays.value),
      desc  : desc.value
    })
  }).then(r=>r.json());

  Swal.fire({icon:r.status?'success':'error',text:r.msg});
  resetForm();
  loadData();
}

async function delRow(){
  if(!row.value) return Swal.fire({icon:'warning',text:'Data belum dipilih'});
  const c = await Swal.fire({icon:'warning',text:'Yakin mau hapus baris ini.?',showCancelButton:true,confirmButtonText:'Ya, Hapus'});
  if(!c.isConfirmed) return;
  bootstrap.Offcanvas.getOrCreateInstance(formData).hide();
  await fetch(url,{method:'POST',body:new URLSearchParams({
    action:'del_row',name:state.sheet,row:row.value
  })});
  resetForm();
  loadData();
}

function resetForm(){
  row.value=''; date.value=times; week.value=''; wages.value=debt.value=pays.value=desc.value=''; work.checked=over.checked=false; username.value=''; del.classList.add('d-none');
}


/* == SHARE PDF == */
async function sharePDF(){
  const off = bootstrap.Offcanvas.getOrCreateInstance(formData);
  const toggle = document.getElementById('floatBtn');
  const table  = document.getElementById('table');
  const target = document.querySelector('.container');

  off.hide();

  if(!target || !target.innerHTML.trim()){
    Swal.fire({icon:'warning',text:'Data belum ditampilkan'});
    return;
  }

  if(!navigator.canShare){
    Swal.fire({icon:'error',text:'System tidak mendukung'});
    return;
  }

  toggle?.classList.add('d-none');
  table?.classList.add('small');

  showLoading();

  try{
    const canvas = await html2canvas(target,{
      scale:2,
      useCORS:true,
      backgroundColor:'#fff'
    });

    const pdf = new jspdf.jsPDF('p','mm','a4');
    const w = pdf.internal.pageSize.getWidth() - 20;
    const h = canvas.height * w / canvas.width;

    pdf.addImage(canvas,'PNG',10,10,w,h);

    const file = new File(
      [pdf.output('blob')],
      `${state.sheet}.pdf`,
      {type:'application/pdf'}
    );

    await navigator.share({
      title: state.sheet,
      text: `Laporan ${state.sheet}`,
      files: [file]
    });

  }catch(err){
    Swal.fire({icon:'error',title:'Gagal Share',text:err.message||err});
  }finally{
    hideLoading();
    toggle?.classList.remove('d-none');
    table?.classList.remove('small');
  }
}
/* ==INIT == */
document.addEventListener('DOMContentLoaded', loadSheets);

</script>
</body>
</html>