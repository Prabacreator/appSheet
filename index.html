<!doctype html>
<html lang="en">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- style  css -->
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/sweetalert.min.css">
<style>
root{
  --bs-primary:#0d6efd;
  --bs-secondary:#6c757d;
  --bs-success:#198754;
  --bs-info:#0dcaf0;
  --bs-warning:#ffc107;
  --bs-danger:#dc3545;
  --bs-light:#f8f9fa;
  --bs-dark:#212529;
}
@import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500&display=swap');
body {
	font-weight: 300 !important;
	background-image: url(img/praba.jpg);
	background-size: cover;
	background-repeat: no-repeat;
	background-attachment: fixed;
}
@media (min-width: 768px) {
  .container-xl {	
  	max-width: 420px;
  }
}
.transparent{
  color: #f8f9fa;
  background-color: transparent;
}
table{
  width: 100%;
  border-collapse: collapse;
}
table th, td{
  font-size: 0.7rem;
  padding: 0.2rem 0.3rem;
  border: 0.5px solid#f8f9fa;
}
#tbody:hover{
  font-size: 1rem;
  background: #6c757d;
}
#tfoot th{
  border: none;
}

</style>
</head>
<body class="text-bg-dark" onload="showName()">
  <div class="container d-flex justify-content-center flex-column text-capitalize w-100 h-100">
    <header class="mb-auto">
  	  <div class="row mt-2 fw-bold border-bottom">
  	    <div class="col fs-4">
  	        data absensi
  	    </div>
  	    <div class="col timestamp text-end" style="font-size:0.5rem"></div>
  	  </div>
  	  <ol class="list-group list-group-numbered" style="font-size:0.7rem"></ol>
    </header>
  	<main class="m-auto">
  	  <div class="table-responsive my-2"></div>
  	</main>
  	<footer class="mt-auto text-end py-2">
  	  <button type="button" class="btn btn-sm btn-success" onclick="addData()" style="font-size:0.5rem">
  	    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="17px" fill="currentColor"><path d="M480-240Zm-320 80v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q37 0 73 4.5t72 14.5l-67 68q-20-3-39-5t-39-2q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32h240v80H160Zm400 40v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q8 9 12.5 20t4.5 22q0 11-4 22.5T903-340L683-120H560Zm300-263-37-37 37 37ZM620-180h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19ZM480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm0-80q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Z"/></svg>
  	      Tambah Data
  	  </button>
  	</footer>
  </div>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/sweetalert.min.js"></script>
<script>
var scriptUrl = 'https://script.google.com/macros/s/AKfycbySfEt9wVvZl3uHy5eYFiqOj0yy_LqWzNU1dqzyQhAWQFFgPLO40533HrBE54mpkA_7/exec';

document.querySelector('.timestamp').textContent = new Date().toLocaleString('id-ID', { weekday: 'long' }) +' , '+ new Date().getDate() +' '+ new Date().toLocaleString('id-ID', { month: 'long' }) +' '+ new Date().getFullYear();

Swal.fire({
  title: 'Loading...',
  text: 'Please wait',
  allowOutsideClick: false,
  showConfirmButton: false,
  willOpen: () => {
    Swal.showLoading();
  }
});

function showName(){
  var listGroup = document.querySelector('.list-group');
  fetch(scriptUrl)
  .then(response => response.json())
  .then(data => {
    listGroup.innerHTML ='';
    data.workers.forEach((row)=> {
      var listGroupItem = document.createElement('li');
      listGroupItem.className = 'list-group-item d-flex justify-content-between align-items-start transparent border-0';
      listGroupItem.innerHTML =`
      <div class="ms-2 me-auto">
        <div class="fw-bold">${row.workername}</div>
        ${row.timestamp}
      </div>
      <span class="badge text-bg-success rounded-pill" onclick="srcData(['${row.workername}'])">
      <svg xmlns="http://www.w3.org/2000/svg" width="17px" height="17px" viewBox="0 -960 960 960" fill="currentColor"><path d="M480-240 240-480l56-56 144 144v-368h80v368l144-144 56 56-240 240Z"/></svg>
      </span>`;
      listGroup.appendChild(listGroupItem);
    });
    Swal.close();
  })
  .catch(error => Swal.close())
}

function srcData(keyword){
  Swal.fire({
    title: 'Loading...',
    text: 'Please wait',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  });
  let div = document.querySelector(".table-responsive");
  fetch(`${scriptUrl}?keyword=${keyword}`).then(response => response.json()).then(data => {
    div.innerHTML = "";
    let title = document.createElement("div");
    title.className ='row';
    title.innerHTML =`
    <div class="col fs-2 fw-bold">${keyword}</div>
    <div class="col text-end">
    <button type="button" class="btn btn-sm btn-success"  onclick="addData(['${keyword}'])" style="font-size:0.5rem">
  	<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="17px" fill="currentColor"><path d="M167-120q-21 5-36.5-10.5T120-167l40-191 198 198-191 40Zm191-40L160-358l458-458q23-23 57-23t57 23l84 84q23 23 23 57t-23 57L358-160Zm317-600L261-346l85 85 414-414-85-85Z"/></svg>
  	 Tambah Absen</button></div>`;
    div.appendChild(title);
    let table = document.createElement("table");
    table.className = 'transparent font-monospace'
    let thead = table.insertRow();
    thead.id = 'thead';
    thead.innerHTML =`
    <th>No</th>
    <th>Tanggal</th>
    <th>Absen</th>
    <th>Kasbon</th>`;
    let totals = 0;
    data.presences.forEach((row, index)=> {
      let tbody = table.insertRow();
      tbody.id = 'tbody';
      tbody.innerHTML =`
      <th>${index+1}</th>
      <td>${row.timestamp}</td>
      <td class="text-center">${row.presence}</td>
      <td class="text-end">${row.cashreceipt}</td>`;
      totals += parseFloat(row.cashreceipt);
    });
    let tfoot = table.insertRow();
    tfoot.id = 'tfoot';
    tfoot.innerHTML =`
    <th colspan="5" class="text-end">${totals}</th>`;
    div.appendChild(table);
    Swal.close();
  }).catch(error => Swal.close());
}

function addData(key){
  Swal.fire({
    title: 'Add Present',
    html: `
    <div class="text-start">
    <label>Nama</label>
    <input type="text" id="workername" class="form-control" value="${key ? key[0] : ''}">
    <div class="row mt-3">
    <div class="col">
    <label>Absen</label>
    <select id="presence" class="form-control text-center">
    <option>Y</option>
    <option>N</option>
    </select>
    </div><div class="col">
    <label>Kasbon</label>
    <input type="number" id="cashreceipt" class="form-control text-center" value="0" onclick="document.querySelector('#cashreceipt').value=null">
    </div></div></div>`,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: 'Simpan',
    confirmButtonColor: '#198754',
    cancelButtonText: 'Batal',
    preConfirm: () => {
      return {
        timestamp: new Date().toLocaleString('id-ID',{ weekday:'long'})+', '+new Date().toLocaleString('id-ID'),
        workername: document.getElementById('workername').value,
        presence: document.getElementById('presence').value,
        cashreceipt: document.getElementById('cashreceipt').value
      }
    }
  }).then((result) => {
    if (result.value) {
      Swal.fire({
        title: 'Loading...',
        text: 'Please wait',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });
      fetch(scriptUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `timestamp=${result.value.timestamp}&workername=${result.value.workername}&presence=${result.value.presence}&cashreceipt=${result.value.cashreceipt}`
      })
      .then(response => response.text())
      .then(data => {
        srcData(result.value.workername);
        console.log(data);
      })
      .catch(error => console.error(error));
    }
  });
}
</script>
</body>
</html>